
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title></title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="shortcut icon" href="../../../img/favicon.ico" type="image/x-icon"/>
    <link rel="stylesheet" href="../../../css/okadmin.css">
    <link rel="stylesheet" href="../../../lib/loading/okLoading.min.css"/>
    <script type="text/javascript" src="../../../lib/loading/okLoading.min.js"></script>
    <link rel="stylesheet" href="../../../css/oksub.css"/>

</head>
<body class="ok-body home">
<div class="ok-body home">
    <fieldset class="layui-elem-field layui-field-title" >
        <legend>用户设置</legend>
    </fieldset>
    <form class="layui-form layui-form-pane" action="">
        <div class="layui-form-item">
            <label class="layui-form-label">账号</label>
            <div class="layui-input-inline">
                <input type="text" name="username" lay-verify="required|user" autocomplete="off" placeholder="请输入账号" class="layui-input">
            </div>
            <div class="layui-form-mid layui-word-aux">你的登录账号</div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">原密码</label>
            <div class="layui-input-inline">
                <input type="password" name="password" lay-verify="required|pass" placeholder="请输入原密码" autocomplete="off" class="layui-input">
            </div>
            <div class="layui-form-mid layui-word-aux">之前设置的登录密码</div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">新密码</label>
            <div class="layui-input-inline">
                <input type="password" name="new_password" lay-verify="required|pass" placeholder="请输入新密码" autocomplete="off" class="layui-input">
            </div>
            <div class="layui-form-mid layui-word-aux">新的登录密码</div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">再输一遍</label>
            <div class="layui-input-inline">
                <input type="password" name="new_password2" lay-verify="required|pass|passwd" placeholder="再输入一遍新密码" autocomplete="off" class="layui-input">
            </div>
            <div class="layui-form-mid layui-word-aux">再输一遍新的登录密码</div>
        </div>


        <div class="layui-form-item">
            <button class="layui-btn layui-bg-blue" lay-submit="" lay-filter="save">保存</button>
        </div>
    </form>

</div>
<script src="../../../js/common.js"></script>
<script src="../../../lib/layui/layui.js"></script>
<script>
    layui.config({
        base: '../../../js/'
    });
    layui.use(["okUtils","okMock","okLayer","form","jsencrypt"], function () {
        let okUtils = layui.okUtils;
        let okLayer = layui.okLayer;
        let okMock=layui.okMock;
        let form=layui.form;
        let jsencrypt=layui.jsencrypt;


        okLoading.close();
        form.verify({
            user: function(value){
                if(value.length < 5){
                    return '用户名至少5个字符';
                }
            }
            ,pass: [
                /^[\S]{5,12}$/
                ,'密码必须5到12位，且不能出现空格'
            ]
            ,passwd: function(value){
                if(value!==layui.$("input[name=new_password]").val()){
                    return '两次输入的密码不一致';
                }
            }
        });
        form.on('submit(save)', function(data){
            var sendData=data.field;
            sendData["new_password2"]="";
            okUtils.ajax(okMock.admin.login.publicKey, "post",null, true).done(function (response) {
                const publicKey = response.data;
                let JSEncrypt = jsencrypt.JSEncrypt;
                const encrypt = new JSEncrypt();
                encrypt.setPublicKey(publicKey);
                sendData["password"]=encrypt.encrypt(sendData["password"]);
                sendData["new_password"]=encrypt.encrypt(sendData["new_password"]);
                okUtils.ajax(okMock.admin.setting.passwd, "post",sendData, true).done(function (response) {
                    okLayer.time=1000
                    okLayer.greenTickMsg(response.msg, function () {
                        parent.window.location = "../login.html";
                    })
                }).fail(function (error) {
                    okLayer.time=2000
                    okLayer.redCrossMsg(error)
                    console.log(error)
                });
            }).fail(function (error) {
                okLayer.time=2000
                okLayer.redCrossMsg(error)
                console.log(error)
            });
            return false;
        });

    });
</script>

</body>
</html>
