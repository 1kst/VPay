
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title></title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="shortcut icon" href="../../../img/favicon.ico" type="image/x-icon"/>
    <link rel="stylesheet" href="../../../css/okadmin.css">
    <link rel="stylesheet" href="../../../lib/loading/okLoading.min.css"/>
    <script type="text/javascript" src="../../../lib/loading/okLoading.min.js"></script>
    <link rel="stylesheet" href="../../../css/oksub.css"/>

</head>
<body class="ok-body home">
<div class="ok-body home">
    <fieldset class="layui-elem-field layui-field-title" >
        <legend>监控端配置 <span class="layui-badge layui-bg-blue"><a href="" target="_blank" style="color: white">配置指南</a></span> <span class="layui-badge layui-bg-orange"><a href="" target="_blank" style="color: white">下载客户端</a></span></legend>
    </fieldset>

    <form class="layui-form layui-form-pane" lay-filter="form" action="">
        <div class="layui-form-item">
            <label class="layui-form-label">监控端状态</label>
            <div class="layui-input-block">
                <input type="text" name="status" readonly autocomplete="off" placeholder="监控是否掉线" class="layui-input">
            </div>
        </div>

        <div class="layui-form-item">
            <label for="app_mode" class="layui-form-label">工作模式</label>
            <div class="layui-input-inline">
                <select id="app_mode" name="app_mode" lay-verify="required">
                    <option value="1">通知监听</option>
                    <option value="2">Xposed监听</option>
                </select>
            </div>
            <div class="layui-form-mid layui-word-aux">根据App中的提示选择</div>
        </div>
        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">通讯密钥 <span class="layui-badge layui-bg-blue"><a href="#" id="random" style="color: white">随机生成</a></span></label>
            <div class="layui-input-block">
                <textarea placeholder="随机生成密钥" id="token" readonly name="app_token" class="layui-textarea"></textarea>
            </div>
        </div>

        <div class="layui-form-item">
            <button class="layui-btn layui-bg-blue" lay-submit="" lay-filter="save">保存</button>
            <button class="layui-btn layui-bg-red" type="button" id="setting">客户端绑定</button>
        </div>
    </form>
</div>
<script src="../../../js/common.js"></script>
<script src="../../../lib/layui/layui.js"></script>
<script>
    layui.config({
        base: '../../../js/'
    });
    layui.use(["okUtils","okMock","okLayer","form"], function () {
        let okUtils = layui.okUtils;
        let okLayer = layui.okLayer;
        let okMock=layui.okMock;
        let form=layui.form;



        function randomString(len) {
            len = len || 32;
            var $chars = 'ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678';    /****默认去掉了容易混淆的字符oOLl,9gq,Vv,Uu,I1****/
            var maxPos = $chars.length;
            var pwd = '';
            for (var i = 0; i < len; i++) {
                pwd += $chars.charAt(Math.floor(Math.random() * maxPos));
            }
            return pwd;
        }

        okLoading.close();
        okUtils.ajax(okMock.admin.data.app, "post",null, true).done(function (response) {
            form.val("form",response.data);
        }).fail(function (error) {
            okLayer.time=2000
            okLayer.redCrossMsg(error)
            console.log(error)
        });

        layui.$("#random").on("click",function (e) {
            const token = randomString(64);
            layui.$("textarea").val(token)
        });
        form.on('submit(save)', function(data){
            var sendData=data.field;
            okUtils.ajax(okMock.admin.setting.app, "post",sendData, true).done(function (response) {
                okLayer.time=1000
                okLayer.greenTickMsg(response.msg, function () {
                })
            }).fail(function (error) {
                okLayer.time=2000
                okLayer.redCrossMsg(error)
                console.log(error)
            });
            return false;
        });

        layui.$("#setting").on("click",function (e) {
            const js = {
                'url': window.location.protocol + "//" + window.location.host,
                'token': layui.$("textarea").val()
            };
            layer.tab({
                area: ['200px', '250px'],
                tab: [{
                    title: '扫码绑定',
                    content: "<img style='width:200px' src='/api/api/qr?url="+encodeURIComponent(JSON.stringify(js)+"'/>")
                }]
            });

        });
    });
</script>

</body>
</html>
