
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title></title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="shortcut icon" href="../../../img/favicon.ico" type="image/x-icon"/>
  <link rel="stylesheet" href="../../../css/okadmin.css">
  <link rel="stylesheet" href="../../../lib/loading/okLoading.min.css"/>
  <script type="text/javascript" src="../../../lib/loading/okLoading.min.js"></script>
  <link rel="stylesheet" href="../../../css/oksub.css"/>

</head>
<body class="ok-body home">
<div class="ok-body home">
  <fieldset class="layui-elem-field layui-field-title" >
    <legend>APP列表 <span class="layui-badge layui-bg-blue"><a href="" target="_blank" style="color: white">配置指南</a></span></legend>
  </fieldset>

  <table id="app" lay-filter="app"></table>

  <script id="barDemo" type="text/html">
    <a class="layui-btn layui-btn-xs " lay-event="modify">修改</a>
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del">删除</a>
    <button id="btn" class="layui-btn layui-btn-xs layui-bg-blue" data-clipboard-text="{{d.connect_key}}" >复制密钥</button>
  </script>

  <script type="text/html" id="toolbarTpl">
    <div class="layui-btn-container">
      <button class="layui-btn layui-btn-sm layui-bg-blue" lay-event="add">添加APP</button>
    </div>
  </script>

</div>
<script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script>
<script src="../../../js/common.js"></script>
<script src="../../../lib/layui/layui.js"></script>
<script>
  layui.config({
    base: '../../../js/'
  });
  layui.use(["okUtils","okMock","okLayer","form","table"], function () {
    let okUtils = layui.okUtils;
    let okMock=layui.okMock;
    let form=layui.form;
    let table=layui.table;
    var $=layui.$;
    var clipboard = new ClipboardJS('#btn');
    let okLayer = layui.okLayer;



    clipboard.on('success', function(e) {
      layer.msg("复制成功");
    });

    clipboard.on('error', function(e) {
      layer.msg("复制失败");
    });


    okLoading.close();


   let myTable = table.render({
      elem: '#app'
      , height: 'full-40'
      , url: okUtils.getUrl(okMock.admin.app.list)
     ,where: {
       "token": localStorage.getItem("token")
     }
      ,limit: 15
      ,page: true
      ,even: true
      ,toolbar: "#toolbarTpl"
      , cols: [[ //表头
        {field: 'id', title: 'ID', width: 60},
        {title: '操作', width: 216, align: 'center', toolbar: '#barDemo'},
        {field: 'app_name', title: '应用名称', minWidth: 200},
        {field: 'notify_url', title: '异步回调地址', minWidth: 380},
        {field: 'connect_key', title: '通讯密钥', minWidth: 400}
      ]]
    });
    //监听行工具事件
    table.on('tool(app)', function (obj) { //注：tool 是工具条事件名，test 是 table 原始容器的属性 lay-filter="对应的值"
      var data = obj.data //获得当前行数据
              , layEvent = obj.event; //获得 lay-event 对应的值
      if (layEvent === 'del') {
        layer.confirm('确定要删除该应用吗？', function (index) {
          layer.msg('操作中', {
            icon: 16
            , shade: 0.01
          });
          okUtils.ajax(okMock.admin.app.del, "post", {id:data.id}, true).done(function (response) {
            layer.msg("操作成功！");
            myTable.reload();
          }).fail(function (error) {
            layer.msg(error);

          });


        });
      }
      else if(layEvent === 'modify'){
        parent.layui.okLayer.open("修改应用", "pages/app/edit.html" ,2, "58%", "70%", function (layero, index) {
          parent.layer.iframeAuto(index);
          const layui = parent.window[layero.find('iframe')[0]['name']].layui;
          layui.$("input[name=id]").val(data.id);
          layui.$("input[name=app_name]").val(data.app_name);
          layui.$("input[name=notify_url]").val(data.notify_url);
          layui.$("textarea").val(data.connect_key);
          //  layero.layui.form.val("form",data);
        }, function () {
          myTable.reload();
        })
      }

    });


    //头工具栏事件
    table.on('toolbar(app)', function (obj) {
      var layEvent=obj.event;
      if(layEvent==="add"){
        parent.layui.okLayer.open("添加应用", "pages/app/edit.html" ,2, "58%", "70%", function (layero, index) {
          parent.layer.iframeAuto(index);
          //layero.layui.form.val("form",{});
        }, function () {
          myTable.reload();
        })
      }
    });


  });
</script>

</body>
</html>
